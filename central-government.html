<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Central Government Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card {
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .result-box {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }
      .error-message {
        color: #dc3545;
        margin-top: 10px;
      }
      .nav-link {
        color: #0d6efd;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container">
        <a class="navbar-brand" href="#">Central Government Dashboard</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Back to Role Selection</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Connection Status -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Connection Status</h5>
        </div>
        <div class="card-body">
          <div id="connectionStatus">Not Connected</div>
          <button id="connectWallet" class="btn btn-primary mt-2">
            Connect as Central Government
          </button>
        </div>
      </div>

      <!-- Entity Management -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Entity Management</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Register New Entity</label>
            <div class="input-group">
              <input
                type="text"
                id="entityAddress"
                class="form-control"
                placeholder="Entity Address"
              />
              <input
                type="text"
                id="entityName"
                class="form-control"
                placeholder="Entity Name"
              />
              <button id="registerEntity" class="btn btn-primary">
                Register
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Deactivate Entity</label>
            <div class="input-group">
              <input
                type="text"
                id="deactivateAddress"
                class="form-control"
                placeholder="Entity Address"
              />
              <button id="deactivateEntity" class="btn btn-danger">
                Deactivate
              </button>
            </div>
          </div>

          <div class="form-group">
            <label>Issue Funds</label>
            <div class="input-group">
              <input
                type="text"
                id="fundAddress"
                class="form-control"
                placeholder="Entity Address"
              />
              <input
                type="number"
                id="fundAmount"
                class="form-control"
                placeholder="Amount (ETH)"
              />
              <button id="issueFunds" class="btn btn-success">
                Issue Funds
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Monitoring -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Monitoring</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>View All Entities</label>
            <button id="getAllEntities" class="btn btn-info">
              Get All Entities
            </button>
            <div id="allEntitiesResult" class="result-box"></div>
          </div>

          <div class="form-group">
            <label>View Entity Details</label>
            <div class="input-group">
              <input
                type="text"
                id="queryAddress"
                class="form-control"
                placeholder="Entity Address"
              />
              <button id="getEntityDetails" class="btn btn-info">Query</button>
            </div>
            <div id="entityDetailsResult" class="result-box"></div>
          </div>

          <div class="form-group">
            <label>View All Spending Records</label>
            <div class="input-group">
              <input
                type="number"
                id="spendingOffset"
                class="form-control"
                placeholder="Offset"
                value="0"
              />
              <input
                type="number"
                id="spendingLimit"
                class="form-control"
                placeholder="Limit"
                value="5"
              />
              <button id="getSpendingRecords" class="btn btn-info">
                Query
              </button>
            </div>
            <div id="spendingRecordsResult" class="result-box"></div>
          </div>

          <div class="form-group">
            <label>Contract Balance</label>
            <button id="getContractBalance" class="btn btn-info">
              Get Contract Balance
            </button>
            <div id="contractBalanceResult" class="result-box"></div>
          </div>
        </div>
      </div>

      <!-- Fund Request Management -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Fund Request Management</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>View All Fund Requests</label>
            <div class="input-group">
              <input
                type="number"
                id="fundRequestOffset"
                class="form-control"
                placeholder="Offset"
                value="0"
              />
              <input
                type="number"
                id="fundRequestLimit"
                class="form-control"
                placeholder="Limit"
                value="5"
              />
              <button id="getAllFundRequests" class="btn btn-info">
                Query
              </button>
            </div>
            <div id="allFundRequestsResult" class="result-box"></div>
          </div>

          <div class="form-group mt-3">
            <label>Process Fund Request</label>
            <div class="input-group mb-2">
              <input
                type="number"
                id="requestId"
                class="form-control"
                placeholder="Request ID"
              />
            </div>
            <div class="btn-group">
              <button id="approveRequest" class="btn btn-success">
                Approve Request
              </button>
              <button id="rejectRequest" class="btn btn-danger">
                Reject Request
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Issued Funds Management -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Issued Funds Management</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>View All Issued Funds</label>
            <div class="input-group">
              <input
                type="number"
                id="issuedFundOffset"
                class="form-control"
                placeholder="Offset"
                value="0"
              />
              <input
                type="number"
                id="issuedFundLimit"
                class="form-control"
                placeholder="Limit"
                value="5"
              />
              <button id="getAllIssuedFunds" class="btn btn-info">Query</button>
            </div>
            <div id="allIssuedFundsResult" class="result-box"></div>
          </div>

          <div class="form-group mt-3">
            <label>View Entity's Issued Funds</label>
            <div class="input-group mb-2">
              <input
                type="text"
                id="entityIssuedFundAddress"
                class="form-control"
                placeholder="Entity Address"
              />
            </div>
            <div class="input-group">
              <input
                type="number"
                id="entityIssuedFundOffset"
                class="form-control"
                placeholder="Offset"
                value="0"
              />
              <input
                type="number"
                id="entityIssuedFundLimit"
                class="form-control"
                placeholder="Limit"
                value="5"
              />
              <button id="getEntityIssuedFunds" class="btn btn-info">
                Query
              </button>
            </div>
            <div id="entityIssuedFundsResult" class="result-box"></div>
          </div>
        </div>
      </div>

      <!-- Performance Bonus Distribution -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Performance Bonus Distribution</h5>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label>Time Until Next Bonus Distribution</label>
            <button id="getBonusTime" class="btn btn-info">Check Time</button>
            <div id="bonusTimeResult" class="result-box"></div>
          </div>
          <div class="form-group">
            <button id="distributeBonus" class="btn btn-warning">
              Distribute Bonus to Top Performer
            </button>
            <div id="bonusDistributionResult" class="result-box"></div>
          </div>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div id="loading" class="loading">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p>Processing transaction...</p>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Wait for ethers to be loaded
      window.addEventListener("load", function () {
        if (typeof ethers === "undefined") {
          console.error("ethers.js not loaded!");
          return;
        }
        console.log("ethers.js loaded successfully");
      });

      // Contract configuration
      const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
      const contractABI = [
        "function registerEntity(address entityAddress, string memory name) public",
        "function deactivateEntity(address entityAddress) public",
        "function issueFunds(address entityAddress, uint256 amount) public payable",
        "function getEntityDetails(address entityAddress) public view returns (string memory name, bool isActive, uint256 balance)",
        "function getAllEntityAddresses() public view returns (address[] memory)",
        "function getSpendingRecords(uint256 offset, uint256 limit) public view returns (tuple(uint256 id, address entity, string purpose, uint256 amount, string documentHash, uint256 timestamp)[] memory)",
        "function getContractBalance() public view returns (uint256)",
        "function getEntityCount() public view returns (uint256)",
        "function getFundRequests(uint256 offset, uint256 limit) public view returns (tuple(uint256 id, address entity, uint256 amount, string reason, string documentHash, uint256 timestamp, bool isApproved, bool isRejected)[] memory)",
        "function approveFundRequest(uint256 requestId) public",
        "function rejectFundRequest(uint256 requestId) public",
        "function getIssuedFunds(uint256 offset, uint256 limit) public view returns (tuple(uint256 id, address entity, uint256 amount, uint256 timestamp)[] memory)",
        "function getEntityIssuedFunds(address entityAddress, uint256 offset, uint256 limit) public view returns (tuple(uint256 id, address entity, uint256 amount, uint256 timestamp)[] memory)",
        "function distributeBonus() public",
        "function getTimeUntilNextBonus() public view returns (uint256)",
      ];

      let provider, signer, contract;
      const loading = document.getElementById("loading");

      // Initialize buttons as disabled
      function initializeButtons() {
        const buttons = [
          "registerEntity",
          "deactivateEntity",
          "issueFunds",
          "getAllEntities",
          "getEntityDetails",
          "getSpendingRecords",
          "getContractBalance",
          "getAllFundRequests",
          "approveRequest",
          "rejectRequest",
          "getAllIssuedFunds",
          "getEntityIssuedFunds",
          "getBonusTime",
          "distributeBonus",
        ];

        buttons.forEach((buttonId) => {
          const button = document.getElementById(buttonId);
          if (button) {
            button.disabled = true;
            console.log(`Initialized button: ${buttonId}`);
          } else {
            console.error(`Button not found: ${buttonId}`);
          }
        });
      }

      // Connect to the contract
      async function connectToContract() {
        try {
          console.log("Attempting to connect to contract...");

          // Check if ethers is loaded
          if (typeof ethers === "undefined") {
            throw new Error("ethers.js not loaded!");
          }

          // Connect to local Hardhat network with explicit network configuration
          provider = new ethers.providers.JsonRpcProvider(
            "http://127.0.0.1:8545",
            {
              name: "hardhat",
              chainId: 31337,
            }
          );

          // Disable ENS resolution
          provider.ensAddress = null;

          console.log("Provider created");

          // Use the first account (deployer) as Central Government
          const privateKey =
            "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
          signer = new ethers.Wallet(privateKey, provider);
          console.log("Signer created");

          contract = new ethers.Contract(contractAddress, contractABI, signer);
          console.log("Contract instance created");

          // Verify connection by getting contract balance
          const balance = await contract.getContractBalance();
          console.log(
            "Contract balance:",
            ethers.utils.formatEther(balance),
            "ETH"
          );

          document.getElementById("connectionStatus").textContent =
            "Connected as Central Government";
          document.getElementById("connectionStatus").style.color = "green";

          // Enable all buttons after successful connection
          const buttons = [
            "registerEntity",
            "deactivateEntity",
            "issueFunds",
            "getAllEntities",
            "getEntityDetails",
            "getSpendingRecords",
            "getContractBalance",
            "getAllFundRequests",
            "approveRequest",
            "rejectRequest",
            "getAllIssuedFunds",
            "getEntityIssuedFunds",
            "getBonusTime",
            "distributeBonus",
          ];

          buttons.forEach((buttonId) => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.disabled = false;
              console.log(`Enabled button: ${buttonId}`);
            } else {
              console.error(`Button not found: ${buttonId}`);
            }
          });

          console.log("Successfully connected and enabled all buttons");
        } catch (error) {
          console.error("Connection error:", error);
          document.getElementById("connectionStatus").textContent =
            "Connection failed: " + error.message;
          document.getElementById("connectionStatus").style.color = "red";
        }
      }

      // Show loading indicator
      function showLoading() {
        loading.style.display = "block";
      }

      // Hide loading indicator
      function hideLoading() {
        loading.style.display = "none";
      }

      // Show error message
      function showError(elementId, message) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="error-message">${message}</div>`;
      }

      // Format timestamp
      function formatTimestamp(timestamp) {
        return new Date(timestamp.toNumber() * 1000).toLocaleString();
      }

      // Entity Management
      document
        .getElementById("registerEntity")
        .addEventListener("click", async () => {
          try {
            console.log("Register entity button clicked");
            showLoading();
            const address = document.getElementById("entityAddress").value;
            const name = document.getElementById("entityName").value;

            console.log("Input values:", { address, name });

            if (!address || !name) {
              throw new Error("Please enter both address and name");
            }

            // Validate address format
            if (!ethers.utils.isAddress(address)) {
              throw new Error("Invalid Ethereum address format");
            }

            console.log("Attempting to register entity:", { address, name });

            // First check if the entity exists
            try {
              console.log("Checking if entity exists...");
              const [existingName, isActive, balance] =
                await contract.getEntityDetails(address);
              console.log("Entity exists:", {
                existingName,
                isActive,
                balance,
              });

              // Check if the entity actually exists (has a name and is active)
              if (existingName !== "" && isActive) {
                document.getElementById("entityDetailsResult").innerHTML = `
                Entity already exists:<br>
                Name: ${existingName}<br>
                Active: ${isActive}<br>
                Balance: ${ethers.utils.formatEther(balance)} ETH<br>
                Cannot register this address as it's already in use.
              `;
                return;
              }
            } catch (error) {
              console.log("Error checking entity:", error);
            }

            // If we get here, either the entity doesn't exist or has an empty name
            console.log("Proceeding with registration...");
            const tx = await contract.registerEntity(address, name);
            console.log("Registration transaction sent:", tx.hash);
            console.log("Waiting for transaction confirmation...");
            await tx.wait();
            console.log("Registration transaction confirmed");

            document.getElementById("entityDetailsResult").innerHTML = `
            Entity registered successfully!<br>
            Address: ${address}<br>
            Name: ${name}
          `;
            alert("Entity registered successfully!");
          } catch (error) {
            console.error("Registration error:", error);
            showError("entityDetailsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("deactivateEntity")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const address = document.getElementById("deactivateAddress").value;
            const tx = await contract.deactivateEntity(address);
            await tx.wait();
            alert("Entity deactivated successfully!");
          } catch (error) {
            showError("entityDetailsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("issueFunds")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const address = document.getElementById("fundAddress").value;
            const amount = ethers.utils.parseEther(
              document.getElementById("fundAmount").value
            );
            const tx = await contract.issueFunds(address, amount, {
              value: amount,
            });
            await tx.wait();
            alert("Funds issued successfully!");
          } catch (error) {
            showError("entityDetailsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      // Monitoring
      document
        .getElementById("getEntityDetails")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const address = document.getElementById("queryAddress").value;

            console.log("Checking entity details for address:", address);

            // Validate address format
            if (!ethers.utils.isAddress(address)) {
              throw new Error("Invalid Ethereum address format");
            }

            // Create a new provider instance for this query
            const queryProvider = new ethers.providers.JsonRpcProvider(
              "http://127.0.0.1:8545",
              {
                name: "hardhat",
                chainId: 31337,
              }
            );
            queryProvider.ensAddress = null;

            // Create a new contract instance for this query
            const queryContract = new ethers.Contract(
              contractAddress,
              contractABI,
              queryProvider
            );

            console.log("Fetching entity details...");
            const [name, isActive, balance] =
              await queryContract.getEntityDetails(address);
            console.log("Entity details received:", {
              name,
              isActive,
              balance,
            });

            document.getElementById("entityDetailsResult").innerHTML = `
            Name: ${name}<br>
            Active: ${isActive}<br>
            Balance: ${ethers.utils.formatEther(balance)} ETH
          `;
          } catch (error) {
            console.error("Error fetching entity details:", error);
            showError("entityDetailsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("getSpendingRecords")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const offset = parseInt(
              document.getElementById("spendingOffset").value
            );
            const limit = parseInt(
              document.getElementById("spendingLimit").value
            );
            const records = await contract.getSpendingRecords(offset, limit);
            let html = "";
            records.forEach((record) => {
              html += `
                        ID: ${record.id.toString()}<br>
                        Entity: ${record.entity}<br>
                        Purpose: ${record.purpose}<br>
                        Amount: ${ethers.utils.formatEther(
                          record.amount
                        )} ETH<br>
                        Document Hash: ${record.documentHash}<br>
                        Timestamp: ${formatTimestamp(record.timestamp)}<br><br>
                    `;
            });
            document.getElementById("spendingRecordsResult").innerHTML = html;
          } catch (error) {
            showError("spendingRecordsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("getAllEntities")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const addresses = await contract.getAllEntityAddresses();
            let html = "Registered Entities:<br>";
            addresses.forEach((address, index) => {
              html += `${index + 1}. ${address}<br>`;
            });
            document.getElementById("allEntitiesResult").innerHTML = html;
          } catch (error) {
            showError("allEntitiesResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("getContractBalance")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const balance = await contract.getContractBalance();
            document.getElementById(
              "contractBalanceResult"
            ).innerHTML = `Contract Balance: ${ethers.utils.formatEther(
              balance
            )} ETH`;
          } catch (error) {
            showError("contractBalanceResult", error.message);
          } finally {
            hideLoading();
          }
        });

      // Fund Request Management
      document
        .getElementById("getAllFundRequests")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const offset = parseInt(
              document.getElementById("fundRequestOffset").value
            );
            const limit = parseInt(
              document.getElementById("fundRequestLimit").value
            );
            const requests = await contract.getFundRequests(offset, limit);
            let html = "";
            requests.forEach((request) => {
              html += `
                ID: ${request.id.toString()}<br>
                Entity: ${request.entity}<br>
                Amount: ${ethers.utils.formatEther(request.amount)} ETH<br>
                Reason: ${request.reason}<br>
                Document Hash: ${request.documentHash}<br>
                Timestamp: ${formatTimestamp(request.timestamp)}<br>
                Status: ${
                  request.isApproved
                    ? "Approved"
                    : request.isRejected
                    ? "Rejected"
                    : "Pending"
                }<br><br>
              `;
            });
            document.getElementById("allFundRequestsResult").innerHTML = html;
          } catch (error) {
            showError("allFundRequestsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("approveRequest")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const requestId = parseInt(
              document.getElementById("requestId").value
            );
            const tx = await contract.approveFundRequest(requestId);
            await tx.wait();
            alert("Fund request approved successfully!");
          } catch (error) {
            showError("allFundRequestsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("rejectRequest")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const requestId = parseInt(
              document.getElementById("requestId").value
            );
            const tx = await contract.rejectFundRequest(requestId);
            await tx.wait();
            alert("Fund request rejected successfully!");
          } catch (error) {
            showError("allFundRequestsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      // Issued Funds Management
      document
        .getElementById("getAllIssuedFunds")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const offset = parseInt(
              document.getElementById("issuedFundOffset").value
            );
            const limit = parseInt(
              document.getElementById("issuedFundLimit").value
            );
            const funds = await contract.getIssuedFunds(offset, limit);
            let html = "";
            funds.forEach((fund) => {
              html += `
                ID: ${fund.id.toString()}<br>
                Entity: ${fund.entity}<br>
                Amount: ${ethers.utils.formatEther(fund.amount)} ETH<br>
                Timestamp: ${formatTimestamp(fund.timestamp)}<br><br>
              `;
            });
            document.getElementById("allIssuedFundsResult").innerHTML = html;
          } catch (error) {
            showError("allIssuedFundsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      document
        .getElementById("getEntityIssuedFunds")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const address = document.getElementById(
              "entityIssuedFundAddress"
            ).value;
            const offset = parseInt(
              document.getElementById("entityIssuedFundOffset").value
            );
            const limit = parseInt(
              document.getElementById("entityIssuedFundLimit").value
            );
            const funds = await contract.getEntityIssuedFunds(
              address,
              offset,
              limit
            );
            let html = "";
            funds.forEach((fund) => {
              html += `
                ID: ${fund.id.toString()}<br>
                Amount: ${ethers.utils.formatEther(fund.amount)} ETH<br>
                Timestamp: ${formatTimestamp(fund.timestamp)}<br><br>
              `;
            });
            document.getElementById("entityIssuedFundsResult").innerHTML = html;
          } catch (error) {
            showError("entityIssuedFundsResult", error.message);
          } finally {
            hideLoading();
          }
        });

      // Check time until next bonus
      document
        .getElementById("getBonusTime")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const timeUntilBonus = await contract.getTimeUntilNextBonus();
            const hours = timeUntilBonus.div(3600);
            const minutes = timeUntilBonus.mod(3600).div(60);
            document.getElementById(
              "bonusTimeResult"
            ).innerHTML = `Next bonus distribution in: ${hours} hours and ${minutes} minutes`;
          } catch (error) {
            showError("bonusTimeResult", error.message);
          } finally {
            hideLoading();
          }
        });

      // Distribute bonus
      document
        .getElementById("distributeBonus")
        .addEventListener("click", async () => {
          try {
            showLoading();
            const tx = await contract.distributeBonus();
            await tx.wait();
            document.getElementById("bonusDistributionResult").innerHTML =
              "Bonus distributed successfully!";
          } catch (error) {
            showError("bonusDistributionResult", error.message);
          } finally {
            hideLoading();
          }
        });

      // Initialize buttons when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        console.log("Page loaded, initializing buttons...");
        initializeButtons();
      });

      // Event Listeners
      document
        .getElementById("connectWallet")
        .addEventListener("click", connectToContract);
    </script>
  </body>
</html>
